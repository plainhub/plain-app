import{m as we,c as s,o as a,a as r,d as Se,e as Ce,s as Le,f as $e,r as p,u as Ve,ad as Me,ae as Ae,W as q,N as Ne,i as j,ac as d,w as qe,X as Be,Y as Ie,Z as w,a0 as Re,O as B,v as S,A as C,h,t as u,j as _,a8 as He,V as L,U as I,k as m,a2 as Ue,x as Ke,z as Qe,H as xe,D as ze,af as Ge,G as Pe,J as We,ag as je,ah as Ee,T as Fe,ai as Je,aj as Oe,a9 as E,I as Xe,ak as Ye,al as Ze,am as et,ab as tt,an as at,a5 as st,C as nt,K as ot,L as ct}from"./index-Cz0mFrQo.js";import{_ as rt}from"./call-outline-rounded-CzxrdDrI.js";/* empty css                                                             */import{u as lt}from"./contacts-Dstd2yr8.js";const it={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function dt(F,g){return a(),s("svg",it,g[0]||(g[0]=[r("path",{fill:"currentColor",d:"M4.4 19.425q-.5.2-.95-.088T3 18.5V14l8-2l-8-2V5.5q0-.55.45-.837t.95-.088l15.4 6.5q.625.275.625.925t-.625.925z"},null,-1)]))}const ut=we({name:"material-symbols-send-rounded",render:dt}),_t={class:"content"},mt={class:"chat-header"},pt={class:"chat-header-info"},ht={class:"chat-header-name"},ft={key:0,class:"chat-header-address"},vt={class:"chat-header-actions"},gt={key:0,class:"chat-loading"},yt={key:0,class:"chat-date-separator"},kt={class:"chat-bubble-with-actions"},bt={class:"chat-bubble"},Dt=["innerHTML"],Tt={key:1,class:"chat-attachments"},wt=["src","alt"],St=["src"],Ct=["src"],Lt=["href"],$t={key:0,class:"chat-bubble-tags"},Vt={class:"chat-time"},Mt={key:2,class:"no-data-placeholder"},At={class:"chat-input-bar"},Nt=Se({__name:"MessagesView",setup(F){ot("isPhone");const g=Ce(),{app:J,urlTokenKey:O}=Le($e()),i=p([]),{t:$}=Ve(),{loadContacts:X,getContactName:Y,getDisplayName:Z}=lt(),y=Me.SMS,V=st(),M=p(""),f=p(!1),k=p(""),b=p(),{tags:R,fetch:ee}=Ae(y),te=q(()=>{var t;const e=((t=i.value[0])==null?void 0:t.address)||"";return e?Z(e):""}),H=q(()=>{var c;const e=((c=i.value[0])==null?void 0:c.address)||"";return Y(e)?e:""}),A=q(()=>[...i.value].sort((e,t)=>new Date(e.date).getTime()-new Date(t.date).getTime()));function U(e){return e.type===2||e.type===4}function ae(e){if(e===0)return!0;const t=new Date(A.value[e].date).toDateString(),c=new Date(A.value[e-1].date).toDateString();return t!==c}function se(e){const t=new Date(e),c=new Date,l=new Date;return l.setDate(l.getDate()-1),t.toDateString()===c.toDateString()?$("today"):t.toDateString()===l.toDateString()?$("yesterday"):E(e,{dateStyle:"medium"})}function D(e){return Ze(O.value,e)}function ne(e){return e.startsWith("image/")}function oe(e){return e.startsWith("video/")}function ce(e){return e.startsWith("audio/")}function re(){et(()=>{b.value&&(b.value.scrollTop=b.value.scrollHeight)})}function le(){}const{loading:ie,fetch:v}=Ne({handle:(e,t)=>{f.value=!1,t?Pe($(t),"error"):e&&(i.value=e.sms,re())},document:Ge,variables:()=>({offset:0,limit:5e3,query:ze([{name:"thread_id",op:"",value:M.value}])})}),{mutate:de}=j({document:We});function ue(){var t;const e=(t=i.value[0])==null?void 0:t.address;e&&de({number:e})}const{mutate:_e,loading:me,onDone:pe}=j({document:je});pe(()=>{k.value="",d.emit("sms_sent"),v()});function K(){var c;const e=k.value.trim(),t=(c=i.value[0])==null?void 0:c.address;!e||!t||_e({number:t,body:e})}function he(e){tt(at,{type:y,tags:R.value,item:{key:e.id,title:"",size:0},selected:R.value.filter(t=>{var c;return(c=e.tags)==null?void 0:c.some(l=>l.id===t.id)})})}function fe(){const e=V.query.q;nt(g,e?`/messages?q=${e}`:"/messages")}const Q=()=>{v()},x=e=>{e.type===y&&v()},z=e=>{e.type===y&&v()},N=p(!1);function G(){const e=V.params.threadId;if(M.value=typeof e=="string"?e:Array.isArray(e)?e[0]:"",!M.value){i.value=[],f.value=!1;return}i.value=[],f.value=!0,v()}return qe(()=>V.fullPath,()=>{N.value&&G()}),Be(()=>{ee(),X(),N.value=!0,G(),d.on("item_tags_updated",z),d.on("items_tags_updated",x),d.on("sms_sent",Q)}),Ie(()=>{N.value=!1,d.off("item_tags_updated",z),d.off("items_tags_updated",x),d.off("sms_sent",Q)}),(e,t)=>{const c=Ee,l=xe,ve=rt,ge=He,ye=Je,ke=Qe,be=ut,T=Re("tooltip");return a(),s("div",_t,[r("div",mt,[w((a(),B(l,{onClick:C(fe,["stop"])},{default:S(()=>[_(c)]),_:1})),[[T,e.$t("back")]]),r("div",pt,[r("span",ht,u(te.value),1),H.value?(a(),s("span",ft,u(H.value),1)):h("",!0)]),r("div",vt,[w((a(),B(l,{onClick:C(ue,["stop"])},{default:S(()=>[_(ve)]),_:1})),[[T,e.$t("call")]])])]),r("div",{ref_key:"chatScrollRef",ref:b,class:"chat-messages",onScroll:le},[f.value?(a(),s("div",gt,[_(ge,{indeterminate:"",class:"sm"})])):(a(!0),s(L,{key:1},I(A.value,(n,De)=>{var P,W;return a(),s("div",{key:n.id,class:"chat-message-wrapper"},[ae(De)?(a(),s("div",yt,[r("span",null,u(se(n.date)),1)])):h("",!0),r("div",{class:Fe(["chat-bubble-row",{sent:U(n),received:!U(n)}])},[r("div",kt,[w((a(),B(l,{class:"chat-tag-btn",onClick:C(o=>he(n),["stop"])},{default:S(()=>[_(ye)]),_:2},1032,["onClick"])),[[T,e.$t("add_to_tags")]]),r("div",bt,[n.body?(a(),s("div",{key:0,innerHTML:m(Oe)(n.body)},null,8,Dt)):h("",!0),(P=n.attachments)!=null&&P.length?(a(),s("div",Tt,[(a(!0),s(L,null,I(n.attachments,(o,Te)=>(a(),s(L,{key:`${n.id}-att-${Te}`},[ne(o.contentType)?(a(),s("img",{key:0,class:"chat-attachment-image",src:D(o.path),alt:o.name||"mms-image"},null,8,wt)):oe(o.contentType)?(a(),s("video",{key:1,class:"chat-attachment-video",src:D(o.path),controls:"",preload:"metadata"},null,8,St)):ce(o.contentType)?(a(),s("audio",{key:2,class:"chat-attachment-audio",src:D(o.path),controls:"",preload:"metadata"},null,8,Ct)):(a(),s("a",{key:3,class:"chat-attachment-link",href:D(o.path),target:"_blank",rel:"noopener noreferrer"},u(o.name||o.contentType||o.path),9,Lt))],64))),128))])):h("",!0)])]),(W=n.tags)!=null&&W.length?(a(),s("div",$t,[(a(!0),s(L,null,I(n.tags,o=>(a(),s("span",{key:o.id,class:"chat-tag-chip"},u(o.name),1))),128))])):h("",!0),w((a(),s("span",Vt,[Xe(u(m(Ye)(n.date)),1)])),[[T,m(E)(n.date)]])],2)])}),128)),!f.value&&i.value.length===0?(a(),s("div",Mt,u(e.$t(m(Ue)(m(ie),m(J).permissions,"READ_SMS"))),1)):h("",!0)],544),r("div",At,[_(ke,{modelValue:k.value,"onUpdate:modelValue":t[0]||(t[0]=n=>k.value=n),type:"textarea",rows:1,placeholder:e.$t("write_a_message"),class:"chat-input-field",onKeydown:Ke(C(K,["exact","prevent"]),["enter"])},null,8,["modelValue","placeholder","onKeydown"]),_(l,{class:"chat-send-btn",loading:m(me),onClick:K},{default:S(()=>[_(be)]),_:1},8,["loading"])])])}}}),Ht=ct(Nt,[["__scopeId","data-v-89237137"]]);export{Ht as default};
