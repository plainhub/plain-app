import{d as G,W as V,c as b,h as A,o as l,a4 as ve,a as g,T as re,O as P,cu as Te,aD as nt,cO as st,bT as xe,cR as at,L as Z,f as ye,b1 as Ve,cS as De,aW as we,V as se,U as ce,j as q,t as z,k as F,bi as X,at as de,q as ue,cT as Fe,r as O,az as ze,aA as Ee,A as B,ct as ot,s as he,bg as it,bd as ae,bp as lt,c3 as rt,cU as dt,ba as ut,c4 as ct,m as pt,u as Ae,Z as ie,aH as ft,v as Y,x as ne,z as mt,cV as _t,cW as vt,ac as H,ce as Ie,cX as Ue,cY as le,cZ as J,e as gt,M as oe,a5 as ht,N as yt,g as wt,i as ke,w as bt,c_ as It,c$ as $e,X as kt,Y as $t,a0 as Ct,H as St,ci as Tt,a8 as xt,y as Vt,d0 as Dt,d1 as Ft,d2 as zt,G as Et,d3 as At,p as Ut,d4 as ge,aE as Lt,I as Ot,ak as Mt,$ as Pt,aj as Nt,d5 as Wt,d6 as qt,d7 as jt,c8 as Ce,D as Bt,C as Rt,E as Ht}from"./index-Cz0mFrQo.js";import{_ as Qt}from"./expand-more-rounded-U3k9oDqP.js";import{_ as Kt}from"./send-outline-rounded-DqZFT-Nq.js";import{b as Gt}from"./upload-Bx5PF21n.js";const Jt=["width","height","viewBox"],Xt=["cx","cy","r"],Yt=["cx","cy","r"],Zt=G({__name:"ChatDownloadOverlay",props:{downloadInfo:{default:null},ringSize:{default:52},borderRadius:{default:"0px"}},setup(x){at(n=>({b591326e:k.value*.7+" "+k.value*.3}));const h=x,f=["pending","downloading","paused","failed"],C=V(()=>!!h.downloadInfo&&f.includes(h.downloadInfo.status)),v=V(()=>h.ringSize),u=V(()=>h.ringSize/2),a=V(()=>h.ringSize*.4),k=V(()=>+(2*Math.PI*a.value).toFixed(2)),o=V(()=>Math.round(h.ringSize*.38)),r=V(()=>{const n=h.downloadInfo;return!n||n.total<=0?0:Math.min(100,n.downloaded/n.total)}),_=V(()=>{const n=k.value;return+(n-r.value*n).toFixed(2)});return(n,t)=>{var w,y,T,S,N,D;const I=Te,c=nt,U=st,m=xe;return C.value?(l(),b("div",{key:0,class:"download-overlay",style:ve({borderRadius:n.borderRadius})},[(l(),b("svg",{class:re(["progress-ring",{spinning:((w=n.downloadInfo)==null?void 0:w.status)==="pending"}]),width:n.ringSize,height:n.ringSize,viewBox:`0 0 ${v.value} ${v.value}`},[g("circle",{class:"ring-track",cx:u.value,cy:u.value,r:a.value},null,8,Xt),((y=n.downloadInfo)==null?void 0:y.status)!=="pending"?(l(),b("circle",{key:0,class:"ring-progress",cx:u.value,cy:u.value,r:a.value,style:ve({strokeDasharray:k.value,strokeDashoffset:_.value})},null,12,Yt)):A("",!0)],10,Jt)),g("span",{class:"overlay-icon",style:ve({fontSize:o.value+"px"})},[((T=n.downloadInfo)==null?void 0:T.status)==="downloading"?(l(),P(I,{key:0})):((S=n.downloadInfo)==null?void 0:S.status)==="paused"?(l(),P(c,{key:1})):((N=n.downloadInfo)==null?void 0:N.status)==="pending"?(l(),P(U,{key:2})):((D=n.downloadInfo)==null?void 0:D.status)==="failed"?(l(),P(m,{key:3})):A("",!0)],4)],4)):A("",!0)}}}),Le=Z(Zt,[["__scopeId","data-v-e9315927"]]),en={class:"image-container"},tn=["onClick"],nn=["src"],sn={class:"duration"},an=G({__name:"ChatImages",props:{data:{type:Object,required:!0},downloadInfo:{type:Object,default:null},peer:{type:Object,default:null}},setup(x){const h=ye(),f=x,C=["pending","downloading","paused","failed"];function v(r){return C.includes(r)}const u=V(()=>!f.downloadInfo||!v(f.downloadInfo.status));function a(r){return r.thumbnail?r.thumbnail:f.downloadInfo&&v(f.downloadInfo.status)?f.peer&&r.path.startsWith("fsid:")?Fe(h.urlTokenKey,f.peer,r.path.slice(4),"&w=200&h=200"):"":r.src.startsWith("blob:")?r.src:`${r.src}&w=200&h=200`}function k(r){h.lightbox={sources:o.value,index:r,visible:!0}}const o=V(()=>{var t,I,c,U;const r=f.data,_=((I=(t=r==null?void 0:r._content)==null?void 0:t.value)==null?void 0:I.items)??[],n=[];return(U=(c=r==null?void 0:r.data)==null?void 0:c.ids)==null||U.forEach((m,w)=>{const y=_[w];n.push({path:y.uri,src:we(m),viewOriginImage:De(m)||y.uri.endsWith(".gif"),name:y.fileName||Ve(y.uri),duration:y.duration,size:y.size,thumbnail:y.thumbnail,isFromChat:!0})}),n});return(r,_)=>(l(),b("div",en,[(l(!0),b(se,null,ce(o.value,(n,t)=>(l(),b("div",{key:t,class:"media-item",onClick:I=>u.value?k(t):void 0},[a(n)?(l(),b("img",{key:0,class:"image-thumb",src:a(n),onerror:"this.src='/broken-image.png'"},null,8,nn)):A("",!0),g("span",sn,z(F(X)(n.name)?F(de)(n.duration):F(ue)(n.size)),1),q(Le,{"download-info":x.downloadInfo,"ring-size":48,"border-radius":"6px"},null,8,["download-info"])],8,tn))),128))]))}}),on={class:"link-previews"},ln=["onClick"],rn={key:0,class:"preview-image"},dn=["src","alt","onError"],un={class:"preview-content"},cn={key:0,class:"preview-domain"},pn={key:1,class:"preview-title"},fn={key:2,class:"preview-description"},mn={class:"preview-footer"},_n=["src","onError"],vn={class:"preview-site"},gn=G({__name:"ChatLinkPreviews",props:{data:{type:Object,required:!0}},setup(x){const h=x,f=V(()=>{var n,t,I;const o=h.data,r=((t=(n=o==null?void 0:o._content)==null?void 0:n.value)==null?void 0:t.linkPreviews)??[],_=((I=o==null?void 0:o.data)==null?void 0:I.ids)??[];return r.map((c,U)=>{const m=_[U]||"";return{...c,_fileId:m}})});function C(o){return o._fileId&&o._fileId.trim()!==""?we(o._fileId):o.imageUrl}function v(o){return!o.imageUrl||o.hasError?!1:o.imageWidth>=200&&o.imageHeight>=200}function u(o){return!o.imageUrl||o.hasError?!1:o.imageWidth<200||o.imageHeight<200}function a(o){o.hasError=!0}function k(o){window.open(o,"_blank")}return(o,r)=>(l(),b("div",on,[(l(!0),b(se,null,ce(f.value,_=>(l(),b("div",{key:_.url,class:"link-preview-item",onClick:n=>k(_.url)},[v(_)?(l(),b("div",rn,[g("img",{src:C(_),alt:_.title,onError:n=>a(_)},null,40,dn)])):A("",!0),g("div",un,[_.domain?(l(),b("div",cn,z(_.domain.toUpperCase()),1)):A("",!0),_.title?(l(),b("h4",pn,z(_.title),1)):A("",!0),_.description?(l(),b("p",fn,z(_.description),1)):A("",!0),g("div",mn,[u(_)?(l(),b("img",{key:0,src:C(_),class:"preview-small-icon",onError:n=>a(_)},null,40,_n)):A("",!0),g("span",vn,z(_.siteName||_.url),1)])])],8,ln))),128))]))}}),Se=Z(gn,[["__scopeId","data-v-5de56656"]]),hn={class:"player-row"},yn={class:"slider-col"},wn=["value"],bn={class:"times"},In={class:"time"},kn={class:"time"},$n=G({__name:"ChatAudioPlayer",props:{src:{}},setup(x){const h=x,f=O(0),C=O(0),v=O(!1),u=V(()=>C.value>0?f.value/C.value:0);let a=null,k=!1;ze(()=>{a=new Audio(h.src),a.addEventListener("loadedmetadata",()=>{C.value=a.duration}),a.addEventListener("timeupdate",()=>{k||(f.value=a.currentTime)}),a.addEventListener("ended",()=>{v.value=!1,f.value=0}),a.play(),v.value=!0}),Ee(()=>{a==null||a.pause(),a=null});function o(){a&&(v.value?(a.pause(),v.value=!1):(a.play(),v.value=!0))}function r(n){k=!0,f.value=parseFloat(n.target.value)*C.value}function _(n){a&&(a.currentTime=parseFloat(n.target.value)*C.value),k=!1}return(n,t)=>{const I=Te,c=ot;return l(),b("div",{class:"audio-player",onClick:t[0]||(t[0]=B(()=>{},["stop"]))},[g("div",hn,[g("div",yn,[g("input",{class:"slider",type:"range",min:"0",max:"1",step:"0.001",value:u.value,onInput:r,onChange:_},null,40,wn),g("div",bn,[g("span",In,z(F(de)(Math.floor(f.value))),1),g("span",kn,z(F(de)(Math.floor(C.value))),1)])]),g("button",{class:"play-btn",onClick:o},[v.value?(l(),P(I,{key:0})):(l(),P(c,{key:1}))])])])}}}),Cn=Z($n,[["__scopeId","data-v-f2e43f3f"]]),Sn={class:"file-container"},Tn=["onClick"],xn={class:"file-content"},Vn={class:"file-info"},Dn={key:0,class:"file-summary"},Fn={class:"thumb-wrap"},zn=["src","onError"],En=G({__name:"ChatFiles",props:{data:{type:Object,default:()=>({})},downloadInfo:{type:Object,default:null},peer:{type:Object,default:null}},setup(x){const h=x,f=ye(),{urlTokenKey:C}=he(f),v=O(null),u=O([]),a=V(()=>{var I,c,U,m,w;const t=((U=(c=(I=h.data)==null?void 0:I._content)==null?void 0:c.value)==null?void 0:U.items)??[];return(((w=(m=h.data)==null?void 0:m.data)==null?void 0:w.ids)??[]).map((y,T)=>{const S=t[T];return{path:S.uri,src:we(y),viewOriginImage:De(y)||S.uri.endsWith(".gif"),name:Ve(S.fileName??S.uri),duration:S.duration,size:S.size,fileId:y,thumbnail:S.thumbnail,extension:it(S.uri),summary:S.summary||void 0,isFromChat:!0}})}),k=["pending","downloading","paused","failed"],o=V(()=>!!h.downloadInfo&&k.includes(h.downloadInfo.status));function r(t){if(ae(t.name)||X(t.name))return t.thumbnail?t.thumbnail:o.value?h.peer&&t.path.startsWith("fsid:")?Fe(f.urlTokenKey,h.peer,t.path.slice(4),"&w=50&h=50"):"":t.src.startsWith("blob:")?t.src:`${t.src}&w=50&h=50`;const I=t.extension;return I&&!u.value.includes(t.name)?`/ficons/${I}.svg`:"/ficons/default.svg"}function _(t){u.value.includes(t)||u.value.push(t)}function n(t){if(lt(t.name)){v.value=v.value===t.src?null:t.src;return}if(rt(t.name)&&t.fileId){let I=t.fileId;dt(t.path)&&C.value&&(I=ut(C.value,JSON.stringify({path:t.path,name:t.name}))),window.open(`/text-file?id=${encodeURIComponent(I)}`,"_blank")}else if(ct(t.name))window.open(t.src,"_blank");else if(ae(t.name)||X(t.name)){const I=a.value.filter(c=>ae(c.name)||X(c.name));f.lightbox={sources:I,index:I.findIndex(c=>c.src===t.src),visible:!0}}else window.open(t.src,"_blank")}return(t,I)=>(l(),b("div",Sn,[(l(!0),b(se,null,ce(a.value,(c,U)=>(l(),b("div",{key:U,class:"file-item-wrapper"},[g("div",{class:"file-item",onClick:m=>n(c)},[g("div",xn,[g("div",{class:re(["file-name",{playing:v.value===c.src}])},z(c.name),3),g("div",Vn,z(F(ue)(c.size))+z(c.duration>0?" / "+F(de)(c.duration):""),1),c.summary?(l(),b("div",Dn,z(c.summary),1)):A("",!0)]),g("div",Fn,[r(c)?(l(),b("img",{key:0,src:r(c),class:re(["file-thumbnail",{"file-icon":!F(ae)(c.name)&&!F(X)(c.name)}]),onError:m=>_(c.name)},null,42,zn)):A("",!0),q(Le,{"download-info":x.downloadInfo,"ring-size":40,"border-radius":"8px"},null,8,["download-info"])])],8,Tn),v.value===c.src?(l(),P(Cn,{key:0,src:c.src},null,8,["src"])):A("",!0)]))),128))]))}}),An=Z(En,[["__scopeId","data-v-36dc55e4"]]),Un={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function Ln(x,h){return l(),b("svg",Un,h[0]||(h[0]=[g("path",{fill:"currentColor",d:"M4 20q-.825 0-1.412-.587T2 18V6q0-.825.588-1.412T4 4h5.175q.4 0 .763.15t.637.425L12 6h8q.825 0 1.413.588T22 8v10q0 .825-.587 1.413T20 20zm0-2h16V8h-8.825l-2-2H4zm0 0V6z"},null,-1)]))}const On=pt({name:"material-symbols-folder-outline-rounded",render:Ln}),Mn={class:"chat-input"},Pn={class:"textarea-wrapper"},Nn={class:"leading-icons"},Wn=["disable"],qn=G({__name:"ChatInput",props:{modelValue:{},createLoading:{type:Boolean}},emits:["update:modelValue","send-message","send-files","send-images"],setup(x,{emit:h}){const f=h,{t:C}=Ae(),v=O(),u=O(),a=O(!1);function k(){f("send-message","")}function o(m){const w=m.target.files,y=[];for(const T of w)y.push(T);f("send-files",y)}function r(m){const w=m.target.files,y=[];for(const T of w)y.push(T);f("send-images",y)}function _(){u.value.value="",u.value.click()}function n(){v.value.value="",v.value.click()}function t(){a.value=!0}function I(){a.value=!1}function c(m){var y;const w=(y=m.dataTransfer)==null?void 0:y.files;if(a.value=!1,w){const T=[];for(const S of w)T.push(S);T.length&&f("send-files",T)}}function U(m){var y;const w=(y=m.clipboardData)==null?void 0:y.items;if(w){const T=[],S=[];for(const N of w){if(N.kind!=="file")continue;const D=N.getAsFile();D.type.startsWith("image")||D.type.startsWith("video")?T.push(D):S.push(D)}T.length&&(m.preventDefault(),f("send-images",T)),S.length&&(m.preventDefault(),f("send-files",S))}}return(m,w)=>{const y=_t,T=On,S=Kt,N=mt;return l(),b("div",Mn,[g("div",Pn,[ie(g("div",{class:"drag-mask"},z(m.$t("release_to_send_files")),513),[[ft,a.value]]),q(N,{"model-value":m.modelValue,type:"textarea",rows:2,autocomplete:"off",class:"textarea",placeholder:m.$t("chat_input_hint"),"onUpdate:modelValue":w[0]||(w[0]=D=>m.$emit("update:modelValue",D)),onPaste:U,onDrop:B(c,["prevent"]),onDragenter:B(t,["prevent"]),onDragleave:B(I,["prevent"]),onKeydown:[ne(B(k,["exact","prevent"]),["enter"]),w[1]||(w[1]=ne(B(D=>m.$emit("update:modelValue",m.modelValue+`
`),["shift","exact","prevent"]),["enter"])),w[2]||(w[2]=ne(B(D=>m.$emit("update:modelValue",m.modelValue+`
`),["ctrl","exact","prevent"]),["enter"])),w[3]||(w[3]=ne(B(D=>m.$emit("update:modelValue",m.modelValue+`
`),["alt","exact","prevent"]),["enter"])),w[4]||(w[4]=ne(B(D=>m.$emit("update:modelValue",m.modelValue+`
`),["meta","exact","prevent"]),["enter"]))]},{"leading-icon":Y(()=>[g("div",Nn,[g("button",{class:"btn-icon",onClick:_},[q(y)]),g("button",{class:"btn-icon",onClick:n},[q(T)])])]),"trailing-icon":Y(()=>[g("button",{class:"btn-icon btn-send",disable:m.createLoading,onClick:k},[q(S)],8,Wn)]),_:1},8,["model-value","placeholder","onKeydown"])]),g("input",{ref_key:"fileInput",ref:v,style:{display:"none"},type:"file",multiple:"",onChange:o},null,544),g("input",{ref_key:"imageInput",ref:u,style:{display:"none"},type:"file",accept:"image/*, video/*",multiple:"",onChange:r},null,544)])}}}),jn=Z(qn,[["__scopeId","data-v-5983195e"]]),Bn=()=>{const x=new Map,h=new Set;let f=!1;const C=async u=>{var n;if(h.has(u.item.id)||!u.uploads.every(t=>t.status==="done"||t.status==="error"))return;h.add(u.item.id),x.delete(u.item.id);const k=u.item._content,o=[];k.value.items.forEach((t,I)=>{const c=u.uploads[I].file.name;o.push({uri:"fid:"+(u.uploads[I].fileHash||c),size:t.size,duration:t.duration,width:t.width,height:t.height,summary:t.summary,fileName:c})});const r=await Ie.a.mutate({mutation:Ue,variables:{toId:u.toId,content:JSON.stringify({type:k.type,value:{items:o}})}}),_=Ie.a.cache;_.evict({id:_.identify({__typename:"ChatItem",id:u.item.id})}),(n=r==null?void 0:r.data)!=null&&n.sendChatItem&&le(_,r.data.sendChatItem,J,{id:u.toId})},v=()=>{f||(H.on("upload_task_done",u=>{for(const a of x.values())if(a.uploads.some(k=>k.id===u.id)){C(a);break}}),H.on("upload_progress",u=>{for(const a of x.values())if(a.uploads.some(k=>k.id===u.id)){C(a);break}}),f=!0)};return{async enqueue(u,a,k){v();const o={item:u,uploads:a,toId:k};x.set(u.id,o),a.forEach(r=>vt(r,!1)),await C(o)},cancel(u){h.add(u),x.delete(u)}}},Rn={class:"top-app-bar"},Hn={class:"title"},Qn={key:0,class:"loading-state"},Kn={key:0,class:"date"},Gn={class:"chat-title"},Jn={class:"name"},Xn={class:"time"},Yn={key:0,class:"sending"},Zn=["onClick"],es={class:"chat-content"},ts={key:0},ns=["innerHTML"],ss=G({__name:"ChatView",setup(x){const h=ht(),{t:f}=Ae(),C=gt(),{chatText:v}=he(C),u=ye(),{app:a,urlTokenKey:k}=he(u),{getUploads:o}=Gt(),{resolveClient:r}=It(),_=O(),n=O([]),t=oe({}),{enqueue:I,cancel:c}=Bn(),U=O([]),m=oe({}),w=new Map,y=oe({}),T=O(""),S=O([]),N=O(!1),D=oe({});let pe=!1;function Oe(e){if(!e)return"local";try{if(!k.value)return"local";const s=Dt.codec.base64.toBits(e),p=Ft(k.value,s);if(p.startsWith("peer:"))return p}catch{}return"local"}const Me=V(()=>{const e=h.query.id;return typeof e=="string"?e:""}),L=V(()=>Oe(Me.value)),fe=V(()=>L.value.startsWith("peer:")?L.value.slice(5):""),{appDir:me}=a.value,ee=V(()=>S.value.find(e=>e.id===fe.value)??null),Pe=V(()=>{var e,s;return L.value==="local"?((e=a.value)==null?void 0:e.deviceName)??f("my_phone"):((s=ee.value)==null?void 0:s.name)??fe.value});function Ne(e){var s,p;return e.fromId==="me"?f("me"):L.value==="local"?((s=a.value)==null?void 0:s.deviceName)??f("my_phone"):((p=ee.value)==null?void 0:p.name)??e.fromId}function We(e){const s=y[e];return s?`${f("sending")} ${ue(s.uploaded)} (${ue(s.speed)}/s)`:f("sending")}function qe(e,s){if(s===0)return!0;const p=n.value[s-1];return p!=null&&ge(p.createdAt)!==ge(e.createdAt)}function je(e){return{images:an,files:An,linkPreviews:Se}[e]}yt({handle:e=>{e!=null&&e.peers&&(S.value=e.peers)},document:zt,variables:()=>({})}).fetch();const{loading:Be,refetch:be}=wt({handle:async(e,s)=>{s?Et(f(s),"error"):e&&(n.value=e.chatItems,pe||(Q(),pe=!0))},document:J,variables:()=>({id:L.value})}),{mutate:Re,loading:He,onDone:Qe}=ke({document:Ue,options:{update:(e,s)=>{le(e,s.data.sendChatItem,J,{id:L.value})}}}),{mutate:Ke,loading:Ge}=ke({document:At,options:{update:e=>{e.evict({id:e.identify({__typename:"ChatItem",id:T.value})})}}});Qe(()=>{v.value="",Q()});async function Je(e){e.length&&await _e(e,"files")}async function Xe(e){e.length&&await _e(e,"images")}async function _e(e,s,p={}){const i=me,$=o(i,e);$.forEach(d=>{d.status="pending",d.isAppFile=!0});const E=[];for(const d of $){const M={dir:i,uri:d.fileName||d.file.name,size:d.file.size,duration:0,width:0,height:0,summary:p.summary};if(d.file.type.startsWith("video")||X(d.file.name)){const j=await qt(d.file);M.duration=j.duration,M.thumbnail=j.thumbnail,M.width=j.width,M.height=j.height}else if(d.file.type.startsWith("image")){const j=await jt(d.file);M.width=j.width,M.height=j.height}E.push(M)}const R={type:s,value:{items:E}},K={id:"new_"+Ce(),fromId:"me",toId:L.value,createdAt:new Date().toISOString(),content:JSON.stringify(R),_content:R,__typename:"ChatItem",data:{__typename:s==="images"?"MessageImages":"MessageFiles",ids:$.map(d=>URL.createObjectURL(d.file))}};m[K.id]=$,$.forEach(d=>w.set(d.id,K.id)),y[K.id]={uploaded:$.reduce((d,M)=>d+(M.uploadedSize||0),0),speed:$.reduce((d,M)=>d+(M.uploadSpeed||0),0)},U.value=[...U.value,...$],I(K,$,L.value);const te=r("a");le(te.cache,K,J,{id:L.value}),Q()}function Ye(){if(v.value)if(v.value.length>2048)Ze(v.value);else{const e="new_"+Ce(),s={id:e,fromId:"me",toId:L.value,createdAt:new Date().toISOString(),content:JSON.stringify({type:"text",value:{text:v.value}}),_content:{type:"text",value:{text:v.value}},__typename:"ChatItem",data:{__typename:"MessageText",ids:[]}};n.value=[...n.value,s],Q(),Re({toId:L.value,content:s.content}).then(()=>{n.value=n.value.filter(p=>p.id!==e)})}}async function Ze(e){const s=`message-${Date.now()}.txt`,p=new File([e],s,{type:"text/plain"}),i=e.substring(0,250).trim(),$=i.lastIndexOf(" ")>230?i.substring(0,i.lastIndexOf(" "))+"...":i+"...";await _e([p],"files",{summary:$}),v.value=""}function Q(){const e=_.value;e&&setTimeout(()=>{e.scrollTop=e.scrollHeight},100)}function et(e){T.value=e,Ke({id:e}),c(e)}function tt(){const e=Bt([{name:"parent",op:"",value:me},{name:"type",op:"",value:"APP"},{name:"root_path",op:"",value:me}]);Rt(C,`/files?q=${Ht(e)}`)}bt(()=>h.query.id,()=>{pe=!1,n.value=[],be(),Q()});const W={};return ze(()=>{W.upload_progress=e=>{const s=w.get(e.id);if(!s)return;const p=m[s];p&&(y[s]={uploaded:p.reduce((i,$)=>i+($.uploadedSize||0),0),speed:p.reduce((i,$)=>i+($.uploadSpeed||0),0)})},H.on("upload_progress",W.upload_progress),W.message_created=async e=>{const s=r("a"),p=[];for(const i of e){if((i.toId==="local"?"local":`peer:${i.toId}`)!==L.value&&i.fromId!==fe.value)continue;let E=null;i.data&&(E=i.data,E.__typename=i.data.type.split(".").pop()),p.push({...i,data:E,__typename:"ChatItem"})}if(p.length>0){const i=s.cache.readQuery({query:J,variables:{id:L.value}}),$=new Set(((i==null?void 0:i.chatItems)??[]).map(R=>R.id)),E=p.filter(R=>!$.has(R.id));E.length>0&&(le(s.cache,E,J,{id:L.value}),Q())}},H.on("message_created",W.message_created),W.message_deleted=async e=>{const p=r("a").cache;for(const i of e)p.evict({id:p.identify({__typename:"ChatItem",id:i})})},H.on("message_deleted",W.message_deleted),W.message_updated=async e=>{const p=r("a").cache;for(const i of e){let $=null;i.data&&($=i.data,$.__typename=i.data.type.split(".").pop());const E=p.identify({__typename:"ChatItem",id:i.id});p.readFragment({id:E,fragment:$e})&&(p.writeFragment({id:E,fragment:$e,data:{...i,data:$}}),Q())}},H.on("message_updated",W.message_updated),W.download_progress=e=>{const s={};for(const p of e){const i=p.messageId;s[i]||(s[i]={downloaded:0,total:0,speed:0,status:"pending"}),s[i].downloaded+=p.downloaded,s[i].total+=p.total,s[i].speed+=p.speed;const $=p.status,E=s[i].status;$==="downloading"?s[i].status="downloading":$==="paused"&&E!=="downloading"?s[i].status="paused":$==="failed"&&E==="pending"&&(s[i].status="failed")}Object.keys(D).forEach(p=>delete D[p]),Object.assign(D,s)},H.on("download_progress",W.download_progress)}),Ee(()=>{Object.entries(W).forEach(([e,s])=>{H.off(e,s)})}),kt(()=>{N.value=!0}),$t(()=>{N.value=!1}),(e,s)=>{const p=xe,i=St,$=Ut,E=xt,R=Qt,K=Pt,te=Ct("tooltip");return l(),b(se,null,[N.value?(l(),P(Tt,{key:0,to:"#header-end-slot",defer:""},[ie((l(),P(i,{onClick:F(be)},{default:Y(()=>[q(p)]),_:1},8,["onClick"])),[[te,e.$t("refresh")]]),ie((l(),P(i,{onClick:B(tt,["prevent"])},{default:Y(()=>[q($)]),_:1})),[[te,e.$t("files")]])])):A("",!0),g("div",Rn,[g("div",Hn,z(Pe.value),1)]),g("div",{ref_key:"scrollContainer",ref:_,class:"chat-view-body"},[F(Be)&&n.value.length===0?(l(),b("div",Qn,[q(E,{indeterminate:"",class:"sm"})])):(l(!0),b(se,{key:1},ce(n.value,(d,M)=>(l(),b("div",{key:d.id,class:"chat-item"},[qe(d,M)?(l(),b("div",Kn,z(F(ge)(d.createdAt)),1)):A("",!0),q(K,{modelValue:t[d.id],"onUpdate:modelValue":j=>t[d.id]=j,align:"top-left-to-bottom-left"},{trigger:Y(()=>[g("div",Gn,[g("span",Jn,z(Ne(d)),1),ie((l(),b("time",Xn,[Ot(z(F(Mt)(d.createdAt)),1)])),[[te,F(Lt)(d.createdAt)]]),d.id.startsWith("new_")?(l(),b("span",Yn,z(We(d.id)),1)):A("",!0),q(R,{class:"bi bi-more"})])]),default:Y(()=>[g("div",{class:re(["dropdown-item",{disabled:F(Ge)}]),onClick:j=>{et(d.id),t[d.id]=!1}},z(e.$t("delete_message")),11,Zn)]),_:2},1032,["modelValue","onUpdate:modelValue"]),g("div",es,[d._content.type==="text"?(l(),b("div",ts,[g("pre",{innerHTML:F(Nt)(d._content.value.text)},null,8,ns),d._content.value.linkPreviews&&d._content.value.linkPreviews.length?(l(),P(Se,{key:0,data:d},null,8,["data"])):A("",!0)])):(l(),P(Wt(je(d._content.type)),{key:1,data:d,"download-info":D[d.id]??null,peer:ee.value},null,8,["data","download-info","peer"]))])]))),128))],512),!ee.value||ee.value.status==="paired"?(l(),P(jn,{key:1,modelValue:F(v),"onUpdate:modelValue":s[0]||(s[0]=d=>Vt(v)?v.value=d:null),"create-loading":F(He),onSendMessage:Ye,onSendFiles:Je,onSendImages:Xe},null,8,["modelValue","create-loading"])):A("",!0)],64)}}}),rs=Z(ss,[["__scopeId","data-v-fcfe5948"]]);export{rs as default};
