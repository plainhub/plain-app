import{d as K,W as z,c as g,h as E,o,a4 as he,a as l,T as de,O as q,cu as Fe,aD as lt,cQ as dt,bT as ze,cT as rt,L as Z,f as ye,b1 as Ee,cU as xe,aW as we,V as Y,U as ue,j as O,t as b,k as M,bi as ne,at as re,q as ce,cV as Ae,r as P,az as Ue,aA as Me,A as B,ct,s as Le,bg as ut,bd as oe,bp as pt,c3 as _t,cW as ft,ba as mt,c4 as vt,m as ht,u as Oe,Z as ae,aH as gt,v as N,x as se,z as yt,cX as wt,I as te,aC as $t,B as bt,aT as kt,aS as Ie,cY as It,ac as H,ce as Ce,cZ as Pe,c_ as le,c$ as X,e as Ct,M as ie,a5 as St,N as Tt,g as Vt,i as Se,w as Dt,d0 as Ft,d1 as Te,X as zt,Y as Et,a0 as xt,H as At,ci as Ut,a8 as Mt,d2 as Lt,d3 as Ot,d4 as Pt,G as qt,d5 as Nt,p as Wt,bR as jt,d6 as ge,aE as Bt,ak as Rt,$ as Qt,aj as Ht,d7 as Kt,d8 as Gt,d9 as Jt,c8 as Ve,ab as Xt,D as Yt,C as Zt,E as en}from"./index-DLxHt1vi.js";import{_ as tn}from"./expand-more-rounded-DfCq7qhA.js";import{_ as nn}from"./send-outline-rounded-CxWiBGha.js";import{b as sn}from"./upload-CPWSFMaU.js";const an=["width","height","viewBox"],on=["cx","cy","r"],ln=["cx","cy","r"],dn=K({__name:"ChatDownloadOverlay",props:{downloadInfo:{default:null},ringSize:{default:52},borderRadius:{default:"0px"}},setup(T){rt(a=>({b591326e:y.value*.7+" "+y.value*.3}));const h=T,c=["pending","downloading","paused","failed"],C=z(()=>!!h.downloadInfo&&c.includes(h.downloadInfo.status)),m=z(()=>h.ringSize),u=z(()=>h.ringSize/2),s=z(()=>h.ringSize*.4),y=z(()=>+(2*Math.PI*s.value).toFixed(2)),i=z(()=>Math.round(h.ringSize*.38)),d=z(()=>{const a=h.downloadInfo;return!a||a.total<=0?0:Math.min(100,a.downloaded/a.total)}),f=z(()=>{const a=y.value;return+(a-d.value*a).toFixed(2)});return(a,t)=>{var k,$,F,D,j,x;const I=Fe,p=lt,L=dt,v=ze;return C.value?(o(),g("div",{key:0,class:"download-overlay",style:he({borderRadius:a.borderRadius})},[(o(),g("svg",{class:de(["progress-ring",{spinning:((k=a.downloadInfo)==null?void 0:k.status)==="pending"}]),width:a.ringSize,height:a.ringSize,viewBox:`0 0 ${m.value} ${m.value}`},[l("circle",{class:"ring-track",cx:u.value,cy:u.value,r:s.value},null,8,on),(($=a.downloadInfo)==null?void 0:$.status)!=="pending"?(o(),g("circle",{key:0,class:"ring-progress",cx:u.value,cy:u.value,r:s.value,style:he({strokeDasharray:y.value,strokeDashoffset:f.value})},null,12,ln)):E("",!0)],10,an)),l("span",{class:"overlay-icon",style:he({fontSize:i.value+"px"})},[((F=a.downloadInfo)==null?void 0:F.status)==="downloading"?(o(),q(I,{key:0})):((D=a.downloadInfo)==null?void 0:D.status)==="paused"?(o(),q(p,{key:1})):((j=a.downloadInfo)==null?void 0:j.status)==="pending"?(o(),q(L,{key:2})):((x=a.downloadInfo)==null?void 0:x.status)==="failed"?(o(),q(v,{key:3})):E("",!0)],4)],4)):E("",!0)}}}),qe=Z(dn,[["__scopeId","data-v-e9315927"]]),rn={class:"image-container"},cn=["onClick"],un=["src"],pn={class:"duration"},_n=K({__name:"ChatImages",props:{data:{type:Object,required:!0},downloadInfo:{type:Object,default:null},peer:{type:Object,default:null}},setup(T){const h=ye(),c=T,C=["pending","downloading","paused","failed"];function m(d){return C.includes(d)}const u=z(()=>!c.downloadInfo||!m(c.downloadInfo.status));function s(d){return d.thumbnail?d.thumbnail:c.downloadInfo&&m(c.downloadInfo.status)?c.peer&&d.path.startsWith("fsid:")?Ae(h.urlTokenKey,c.peer,d.path.slice(4),"&w=200&h=200"):"":d.src.startsWith("blob:")?d.src:`${d.src}&w=200&h=200`}function y(d){h.lightbox={sources:i.value,index:d,visible:!0}}const i=z(()=>{var t,I,p,L;const d=c.data,f=((I=(t=d==null?void 0:d._content)==null?void 0:t.value)==null?void 0:I.items)??[],a=[];return(L=(p=d==null?void 0:d.data)==null?void 0:p.ids)==null||L.forEach((v,k)=>{const $=f[k];a.push({path:$.uri,src:we(v),viewOriginImage:xe(v)||$.uri.endsWith(".gif"),name:$.fileName||Ee($.uri),duration:$.duration,size:$.size,thumbnail:$.thumbnail,isFromChat:!0})}),a});return(d,f)=>(o(),g("div",rn,[(o(!0),g(Y,null,ue(i.value,(a,t)=>(o(),g("div",{key:t,class:"media-item",onClick:I=>u.value?y(t):void 0},[s(a)?(o(),g("img",{key:0,class:"image-thumb",src:s(a),onerror:"this.src='/broken-image.png'"},null,8,un)):E("",!0),l("span",pn,b(M(ne)(a.name)?M(re)(a.duration):M(ce)(a.size)),1),O(qe,{"download-info":T.downloadInfo,"ring-size":48,"border-radius":"6px"},null,8,["download-info"])],8,cn))),128))]))}}),fn={class:"link-previews"},mn=["onClick"],vn={key:0,class:"preview-image"},hn=["src","alt","onError"],gn={class:"preview-content"},yn={key:0,class:"preview-domain"},wn={key:1,class:"preview-title"},$n={key:2,class:"preview-description"},bn={class:"preview-footer"},kn=["src","onError"],In={class:"preview-site"},Cn=K({__name:"ChatLinkPreviews",props:{data:{type:Object,required:!0}},setup(T){const h=T,c=z(()=>{var a,t,I;const i=h.data,d=((t=(a=i==null?void 0:i._content)==null?void 0:a.value)==null?void 0:t.linkPreviews)??[],f=((I=i==null?void 0:i.data)==null?void 0:I.ids)??[];return d.map((p,L)=>{const v=f[L]||"";return{...p,_fileId:v}})});function C(i){return i._fileId&&i._fileId.trim()!==""?we(i._fileId):i.imageUrl}function m(i){return!i.imageUrl||i.hasError?!1:i.imageWidth>=200&&i.imageHeight>=200}function u(i){return!i.imageUrl||i.hasError?!1:i.imageWidth<200||i.imageHeight<200}function s(i){i.hasError=!0}function y(i){window.open(i,"_blank")}return(i,d)=>(o(),g("div",fn,[(o(!0),g(Y,null,ue(c.value,f=>(o(),g("div",{key:f.url,class:"link-preview-item",onClick:a=>y(f.url)},[m(f)?(o(),g("div",vn,[l("img",{src:C(f),alt:f.title,onError:a=>s(f)},null,40,hn)])):E("",!0),l("div",gn,[f.domain?(o(),g("div",yn,b(f.domain.toUpperCase()),1)):E("",!0),f.title?(o(),g("h4",wn,b(f.title),1)):E("",!0),f.description?(o(),g("p",$n,b(f.description),1)):E("",!0),l("div",bn,[u(f)?(o(),g("img",{key:0,src:C(f),class:"preview-small-icon",onError:a=>s(f)},null,40,kn)):E("",!0),l("span",In,b(f.siteName||f.url),1)])])],8,mn))),128))]))}}),De=Z(Cn,[["__scopeId","data-v-5de56656"]]),Sn={class:"player-row"},Tn={class:"slider-col"},Vn=["value"],Dn={class:"times"},Fn={class:"time"},zn={class:"time"},En=K({__name:"ChatAudioPlayer",props:{src:{}},setup(T){const h=T,c=P(0),C=P(0),m=P(!1),u=z(()=>C.value>0?c.value/C.value:0);let s=null,y=!1;Ue(()=>{s=new Audio(h.src),s.addEventListener("loadedmetadata",()=>{C.value=s.duration}),s.addEventListener("timeupdate",()=>{y||(c.value=s.currentTime)}),s.addEventListener("ended",()=>{m.value=!1,c.value=0}),s.play(),m.value=!0}),Me(()=>{s==null||s.pause(),s=null});function i(){s&&(m.value?(s.pause(),m.value=!1):(s.play(),m.value=!0))}function d(a){y=!0,c.value=parseFloat(a.target.value)*C.value}function f(a){s&&(s.currentTime=parseFloat(a.target.value)*C.value),y=!1}return(a,t)=>{const I=Fe,p=ct;return o(),g("div",{class:"audio-player",onClick:t[0]||(t[0]=B(()=>{},["stop"]))},[l("div",Sn,[l("div",Tn,[l("input",{class:"slider",type:"range",min:"0",max:"1",step:"0.001",value:u.value,onInput:d,onChange:f},null,40,Vn),l("div",Dn,[l("span",Fn,b(M(re)(Math.floor(c.value))),1),l("span",zn,b(M(re)(Math.floor(C.value))),1)])]),l("button",{class:"play-btn",onClick:i},[m.value?(o(),q(I,{key:0})):(o(),q(p,{key:1}))])])])}}}),xn=Z(En,[["__scopeId","data-v-f2e43f3f"]]),An={class:"file-container"},Un=["onClick"],Mn={class:"file-content"},Ln={class:"file-info"},On={key:0,class:"file-summary"},Pn={class:"thumb-wrap"},qn=["src","onError"],Nn=K({__name:"ChatFiles",props:{data:{type:Object,default:()=>({})},downloadInfo:{type:Object,default:null},peer:{type:Object,default:null}},setup(T){const h=T,c=ye(),{urlTokenKey:C}=Le(c),m=P(null),u=P([]),s=z(()=>{var I,p,L,v,k;const t=((L=(p=(I=h.data)==null?void 0:I._content)==null?void 0:p.value)==null?void 0:L.items)??[];return(((k=(v=h.data)==null?void 0:v.data)==null?void 0:k.ids)??[]).map(($,F)=>{const D=t[F];return{path:D.uri,src:we($),viewOriginImage:xe($)||D.uri.endsWith(".gif"),name:Ee(D.fileName??D.uri),duration:D.duration,size:D.size,fileId:$,thumbnail:D.thumbnail,extension:ut(D.uri),summary:D.summary||void 0,isFromChat:!0}})}),y=["pending","downloading","paused","failed"],i=z(()=>!!h.downloadInfo&&y.includes(h.downloadInfo.status));function d(t){if(oe(t.name)||ne(t.name))return t.thumbnail?t.thumbnail:i.value?h.peer&&t.path.startsWith("fsid:")?Ae(c.urlTokenKey,h.peer,t.path.slice(4),"&w=50&h=50"):"":t.src.startsWith("blob:")?t.src:`${t.src}&w=50&h=50`;const I=t.extension;return I&&!u.value.includes(t.name)?`/ficons/${I}.svg`:"/ficons/default.svg"}function f(t){u.value.includes(t)||u.value.push(t)}function a(t){if(pt(t.name)){m.value=m.value===t.src?null:t.src;return}if(_t(t.name)&&t.fileId){let I=t.fileId;ft(t.path)&&C.value&&(I=mt(C.value,JSON.stringify({path:t.path,name:t.name}))),window.open(`/text-file?id=${encodeURIComponent(I)}`,"_blank")}else if(vt(t.name))window.open(t.src,"_blank");else if(oe(t.name)||ne(t.name)){const I=s.value.filter(p=>oe(p.name)||ne(p.name));c.lightbox={sources:I,index:I.findIndex(p=>p.src===t.src),visible:!0}}else window.open(t.src,"_blank")}return(t,I)=>(o(),g("div",An,[(o(!0),g(Y,null,ue(s.value,(p,L)=>(o(),g("div",{key:L,class:"file-item-wrapper"},[l("div",{class:"file-item",onClick:v=>a(p)},[l("div",Mn,[l("div",{class:de(["file-name",{playing:m.value===p.src}])},b(p.name),3),l("div",Ln,b(M(ce)(p.size))+b(p.duration>0?" / "+M(re)(p.duration):""),1),p.summary?(o(),g("div",On,b(p.summary),1)):E("",!0)]),l("div",Pn,[d(p)?(o(),g("img",{key:0,src:d(p),class:de(["file-thumbnail",{"file-icon":!M(oe)(p.name)&&!M(ne)(p.name)}]),onError:v=>f(p.name)},null,42,qn)):E("",!0),O(qe,{"download-info":T.downloadInfo,"ring-size":40,"border-radius":"8px"},null,8,["download-info"])])],8,Un),m.value===p.src?(o(),q(xn,{key:0,src:p.src},null,8,["src"])):E("",!0)]))),128))]))}}),Wn=Z(Nn,[["__scopeId","data-v-36dc55e4"]]),jn={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function Bn(T,h){return o(),g("svg",jn,h[0]||(h[0]=[l("path",{fill:"currentColor",d:"M4 20q-.825 0-1.412-.587T2 18V6q0-.825.588-1.412T4 4h5.175q.4 0 .763.15t.637.425L12 6h8q.825 0 1.413.588T22 8v10q0 .825-.587 1.413T20 20zm0-2h16V8h-8.825l-2-2H4zm0 0V6z"},null,-1)]))}const Rn=ht({name:"material-symbols-folder-outline-rounded",render:Bn}),Qn={class:"chat-input"},Hn={class:"textarea-wrapper"},Kn={class:"leading-icons"},Gn=["disable"],Jn=K({__name:"ChatInput",props:{modelValue:{},createLoading:{type:Boolean}},emits:["update:modelValue","send-message","send-files","send-images"],setup(T,{emit:h}){const c=h,{t:C}=Oe(),m=P(),u=P(),s=P(!1);function y(){c("send-message","")}function i(v){const k=v.target.files,$=[];for(const F of k)$.push(F);c("send-files",$)}function d(v){const k=v.target.files,$=[];for(const F of k)$.push(F);c("send-images",$)}function f(){u.value.value="",u.value.click()}function a(){m.value.value="",m.value.click()}function t(){s.value=!0}function I(){s.value=!1}function p(v){var $;const k=($=v.dataTransfer)==null?void 0:$.files;if(s.value=!1,k){const F=[];for(const D of k)F.push(D);F.length&&c("send-files",F)}}function L(v){var $;const k=($=v.clipboardData)==null?void 0:$.items;if(k){const F=[],D=[];for(const j of k){if(j.kind!=="file")continue;const x=j.getAsFile();x.type.startsWith("image")||x.type.startsWith("video")?F.push(x):D.push(x)}F.length&&(v.preventDefault(),c("send-images",F)),D.length&&(v.preventDefault(),c("send-files",D))}}return(v,k)=>{const $=wt,F=Rn,D=nn,j=yt;return o(),g("div",Qn,[l("div",Hn,[ae(l("div",{class:"drag-mask"},b(v.$t("release_to_send_files")),513),[[gt,s.value]]),O(j,{"model-value":v.modelValue,type:"textarea",rows:2,autocomplete:"off",class:"textarea",placeholder:v.$t("chat_input_hint"),"onUpdate:modelValue":k[0]||(k[0]=x=>v.$emit("update:modelValue",x)),onPaste:L,onDrop:B(p,["prevent"]),onDragenter:B(t,["prevent"]),onDragleave:B(I,["prevent"]),onKeydown:[se(B(y,["exact","prevent"]),["enter"]),k[1]||(k[1]=se(B(x=>v.$emit("update:modelValue",v.modelValue+`
`),["shift","exact","prevent"]),["enter"])),k[2]||(k[2]=se(B(x=>v.$emit("update:modelValue",v.modelValue+`
`),["ctrl","exact","prevent"]),["enter"])),k[3]||(k[3]=se(B(x=>v.$emit("update:modelValue",v.modelValue+`
`),["alt","exact","prevent"]),["enter"])),k[4]||(k[4]=se(B(x=>v.$emit("update:modelValue",v.modelValue+`
`),["meta","exact","prevent"]),["enter"]))]},{"leading-icon":N(()=>[l("div",Kn,[l("button",{class:"btn-icon",onClick:f},[O($)]),l("button",{class:"btn-icon",onClick:a},[O(F)])])]),"trailing-icon":N(()=>[l("button",{class:"btn-icon btn-send",disable:v.createLoading,onClick:y},[O(D)],8,Gn)]),_:1},8,["model-value","placeholder","onKeydown"])]),l("input",{ref_key:"fileInput",ref:m,style:{display:"none"},type:"file",multiple:"",onChange:i},null,544),l("input",{ref_key:"imageInput",ref:u,style:{display:"none"},type:"file",accept:"image/*, video/*",multiple:"",onChange:d},null,544)])}}}),Xn=Z(Jn,[["__scopeId","data-v-5983195e"]]),Yn={key:0,class:"info-list"},Zn={class:"key-value"},es={class:"key"},ts={class:"value"},ns={class:"key-value"},ss={class:"key"},as={class:"value"},os={class:"key-value"},is={class:"key"},ls={class:"value"},ds={class:"key-value"},rs={class:"key"},cs={class:"value"},us={key:1,class:"confirm-text"},ps=K({__name:"ChatInfoModal",props:{peer:{type:Object,default:null},onClear:{type:Function,required:!0}},setup(T){const h=T,c=P(!1),C=P(!1);function m(){Ie()}async function u(){C.value=!0;try{await h.onClear(),Ie()}finally{C.value=!1}}return(s,y)=>{const i=$t,d=bt,f=kt;return o(),q(f,{onClose:m},{headline:N(()=>[te(b(s.$t("chat_info")),1)]),content:N(()=>[T.peer?(o(),g("div",Yn,[l("div",Zn,[l("span",es,b(s.$t("ip_address")),1),l("span",ts,b(T.peer.ip),1)]),l("div",ns,[l("span",ss,b(s.$t("port")),1),l("span",as,b(T.peer.port),1)]),l("div",os,[l("span",is,b(s.$t("device_type")),1),l("span",ls,b(T.peer.deviceType),1)]),l("div",ds,[l("span",rs,b(s.$t("status")),1),l("span",cs,b(T.peer.status),1)])])):E("",!0),c.value?(o(),g("p",us,b(s.$t("clear_messages_confirm")),1)):E("",!0)]),actions:N(()=>[c.value?(o(),g(Y,{key:0},[O(i,{onClick:y[0]||(y[0]=a=>c.value=!1)},{default:N(()=>[te(b(s.$t("cancel")),1)]),_:1}),O(d,{loading:C.value,onClick:u},{default:N(()=>[te(b(s.$t("clear_messages")),1)]),_:1},8,["loading"])],64)):(o(),g(Y,{key:1},[O(i,{onClick:m},{default:N(()=>[te(b(s.$t("cancel")),1)]),_:1}),O(i,{onClick:y[1]||(y[1]=a=>c.value=!0)},{default:N(()=>[te(b(s.$t("clear_messages")),1)]),_:1})],64))]),_:1})}}}),_s=Z(ps,[["__scopeId","data-v-c1a4c816"]]),fs=()=>{const T=new Map,h=new Set;let c=!1;const C=async u=>{var a;if(h.has(u.item.id)||!u.uploads.every(t=>t.status==="done"||t.status==="error"))return;h.add(u.item.id),T.delete(u.item.id);const y=u.item._content,i=[];y.value.items.forEach((t,I)=>{const p=u.uploads[I].file.name;i.push({uri:"fid:"+(u.uploads[I].fileHash||p),size:t.size,duration:t.duration,width:t.width,height:t.height,summary:t.summary,fileName:p})});const d=await Ce.a.mutate({mutation:Pe,variables:{toId:u.toId,content:JSON.stringify({type:y.type,value:{items:i}})}}),f=Ce.a.cache;f.evict({id:f.identify({__typename:"ChatItem",id:u.item.id})}),(a=d==null?void 0:d.data)!=null&&a.sendChatItem&&le(f,d.data.sendChatItem,X,{id:u.toId})},m=()=>{c||(H.on("upload_task_done",u=>{for(const s of T.values())if(s.uploads.some(y=>y.id===u.id)){C(s);break}}),H.on("upload_progress",u=>{for(const s of T.values())if(s.uploads.some(y=>y.id===u.id)){C(s);break}}),c=!0)};return{async enqueue(u,s,y){m();const i={item:u,uploads:s,toId:y};T.set(u.id,i),s.forEach(d=>It(d,!1)),await C(i)},cancel(u){h.add(u),T.delete(u)}}},ms={class:"top-app-bar"},vs={class:"title"},hs={key:0,class:"loading-state"},gs={key:0,class:"date"},ys={class:"chat-title"},ws={class:"name"},$s={class:"time"},bs={key:0,class:"sending"},ks=["onClick"],Is={class:"chat-content"},Cs={key:0},Ss=["innerHTML"],Ts=K({__name:"ChatView",setup(T){const h=St(),{t:c}=Oe(),C=Ct(),m=z({get:()=>C.chatTexts[A.value]??"",set:e=>{C.chatTexts[A.value]=e}}),u=ye(),{app:s,urlTokenKey:y}=Le(u),{getUploads:i}=sn(),{resolveClient:d}=Ft(),f=P(),a=P([]),t=ie({}),{enqueue:I,cancel:p}=fs(),L=P([]),v=ie({}),k=new Map,$=ie({}),F=P(""),D=P([]),j=P(!1),x=ie({});let pe=!1;function Ne(e){if(!e)return"local";try{if(!y.value)return"local";const n=Lt.codec.base64.toBits(e),_=Ot(y.value,n);if(_.startsWith("peer:"))return _}catch{}return"local"}const We=z(()=>{const e=h.query.id;return typeof e=="string"?e:""}),A=z(()=>Ne(We.value)),_e=z(()=>A.value.startsWith("peer:")?A.value.slice(5):""),{appDir:fe}=s.value,ee=z(()=>D.value.find(e=>e.id===_e.value)??null),je=z(()=>{var e,n;return A.value==="local"?((e=s.value)==null?void 0:e.deviceName)??c("my_phone"):((n=ee.value)==null?void 0:n.name)??_e.value});function Be(e){var n,_;return e.fromId==="me"?c("me"):A.value==="local"?((n=s.value)==null?void 0:n.deviceName)??c("my_phone"):((_=ee.value)==null?void 0:_.name)??e.fromId}function Re(e){const n=$[e];return n?`${c("sending")} ${ce(n.uploaded)} (${ce(n.speed)}/s)`:c("sending")}function Qe(e,n){if(n===0)return!0;const _=a.value[n-1];return _!=null&&ge(_.createdAt)!==ge(e.createdAt)}function He(e){return{images:_n,files:Wn,linkPreviews:De}[e]}Tt({handle:e=>{e!=null&&e.peers&&(D.value=e.peers)},document:Pt,variables:()=>({})}).fetch();const{loading:Ke,refetch:$e}=Vt({handle:async(e,n)=>{n?qt(c(n),"error"):e&&(a.value=e.chatItems,pe||(G(),pe=!0))},document:X,variables:()=>({id:A.value})}),{mutate:Ge,loading:Je,onDone:Xe}=Se({document:Pe,options:{update:(e,n)=>{le(e,n.data.sendChatItem,X,{id:A.value})}}}),{mutate:be,loading:Ye}=Se({document:Nt,options:{update:e=>{e.evict({id:e.identify({__typename:"ChatItem",id:F.value})})}}});Xe(()=>{G()});async function Ze(e){e.length&&await me(e,"files")}async function et(e){e.length&&await me(e,"images")}async function me(e,n,_={}){const r=fe,S=i(r,e);S.forEach(V=>{V.status="pending",V.isAppFile=!0});const U=[];for(const V of S){const w={dir:r,uri:V.fileName||V.file.name,size:V.file.size,duration:0,width:0,height:0,summary:_.summary};if(V.file.type.startsWith("video")||ne(V.file.name)){const Q=await Gt(V.file);w.duration=Q.duration,w.thumbnail=Q.thumbnail,w.width=Q.width,w.height=Q.height}else if(V.file.type.startsWith("image")){const Q=await Jt(V.file);w.width=Q.width,w.height=Q.height}U.push(w)}const R={type:n,value:{items:U}},J={id:"new_"+Ve(),fromId:"me",toId:A.value,createdAt:new Date().toISOString(),content:JSON.stringify(R),_content:R,__typename:"ChatItem",data:{__typename:n==="images"?"MessageImages":"MessageFiles",ids:S.map(V=>URL.createObjectURL(V.file))}};v[J.id]=S,S.forEach(V=>k.set(V.id,J.id)),$[J.id]={uploaded:S.reduce((V,w)=>V+(w.uploadedSize||0),0),speed:S.reduce((V,w)=>V+(w.uploadSpeed||0),0)},L.value=[...L.value,...S],I(J,S,A.value);const ve=d("a");le(ve.cache,J,X,{id:A.value}),G()}function tt(){if(m.value)if(m.value.length>2048)nt(m.value);else{const e="new_"+Ve(),n={id:e,fromId:"me",toId:A.value,createdAt:new Date().toISOString(),content:JSON.stringify({type:"text",value:{text:m.value}}),_content:{type:"text",value:{text:m.value}},__typename:"ChatItem",data:{__typename:"MessageText",ids:[]}};a.value=[...a.value,n],m.value="",G(),Ge({toId:A.value,content:n.content}).then(()=>{a.value=a.value.filter(_=>_.id!==e)})}}async function nt(e){const n=`message-${Date.now()}.txt`,_=new File([e],n,{type:"text/plain"}),r=e.substring(0,250).trim(),S=r.lastIndexOf(" ")>230?r.substring(0,r.lastIndexOf(" "))+"...":r+"...";await me([_],"files",{summary:S}),m.value=""}function G(){const e=f.value;e&&setTimeout(()=>{e.scrollTop=e.scrollHeight},100)}function st(e){F.value=e,be({id:e}),p(e)}function at(){Xt(_s,{peer:ee.value,onClear:ot})}async function ot(){const e=a.value.filter(n=>!n.id.startsWith("new_")).map(n=>n.id);for(const n of e)p(n),F.value=n,await be({id:n})}function it(){const e=Yt([{name:"parent",op:"",value:fe},{name:"type",op:"",value:"APP"},{name:"root_path",op:"",value:fe}]);Zt(C,`/files?q=${en(e)}`)}Dt(()=>h.query.id,()=>{pe=!1,a.value=[],$e(),G()});const W={};return Ue(()=>{W.upload_progress=e=>{const n=k.get(e.id);if(!n)return;const _=v[n];_&&($[n]={uploaded:_.reduce((r,S)=>r+(S.uploadedSize||0),0),speed:_.reduce((r,S)=>r+(S.uploadSpeed||0),0)})},H.on("upload_progress",W.upload_progress),W.message_created=async e=>{const n=d("a"),_=[];for(const r of e){if((r.toId==="local"?"local":`peer:${r.toId}`)!==A.value&&r.fromId!==_e.value)continue;let U=null;r.data&&(U=r.data,U.__typename=r.data.type.split(".").pop()),_.push({...r,data:U,__typename:"ChatItem"})}if(_.length>0){const r=n.cache.readQuery({query:X,variables:{id:A.value}}),S=new Set(((r==null?void 0:r.chatItems)??[]).map(R=>R.id)),U=_.filter(R=>!S.has(R.id));U.length>0&&(le(n.cache,U,X,{id:A.value}),G())}},H.on("message_created",W.message_created),W.message_deleted=async e=>{const _=d("a").cache;for(const r of e)_.evict({id:_.identify({__typename:"ChatItem",id:r})})},H.on("message_deleted",W.message_deleted),W.message_cleared=e=>{if((e==="local"?"local":`peer:${e}`)!==A.value)return;d("a").cache.writeQuery({query:X,variables:{id:A.value},data:{chatItems:[]}}),a.value=[]},H.on("message_cleared",W.message_cleared),W.message_updated=async e=>{const _=d("a").cache;for(const r of e){let S=null;r.data&&(S=r.data,S.__typename=r.data.type.split(".").pop());const U=_.identify({__typename:"ChatItem",id:r.id});_.readFragment({id:U,fragment:Te})&&(_.writeFragment({id:U,fragment:Te,data:{...r,data:S}}),G())}},H.on("message_updated",W.message_updated),W.download_progress=e=>{const n={};for(const _ of e){const r=_.messageId;n[r]||(n[r]={downloaded:0,total:0,speed:0,status:"pending"}),n[r].downloaded+=_.downloaded,n[r].total+=_.total,n[r].speed+=_.speed;const S=_.status,U=n[r].status;S==="downloading"?n[r].status="downloading":S==="paused"&&U!=="downloading"?n[r].status="paused":S==="failed"&&U==="pending"&&(n[r].status="failed")}Object.keys(x).forEach(_=>delete x[_]),Object.assign(x,n)},H.on("download_progress",W.download_progress)}),Me(()=>{Object.entries(W).forEach(([e,n])=>{H.off(e,n)})}),zt(()=>{j.value=!0}),Et(()=>{j.value=!1}),(e,n)=>{const _=ze,r=At,S=Wt,U=jt,R=Mt,J=tn,ve=Qt,V=xt("tooltip");return o(),g(Y,null,[j.value?(o(),q(Ut,{key:0,to:"#header-end-slot",defer:""},[ae((o(),q(r,{onClick:M($e)},{default:N(()=>[O(_)]),_:1},8,["onClick"])),[[V,e.$t("refresh")]]),ae((o(),q(r,{onClick:B(it,["prevent"])},{default:N(()=>[O(S)]),_:1})),[[V,e.$t("files")]])])):E("",!0),l("div",ms,[l("div",vs,b(je.value),1),ae((o(),q(r,{onClick:at},{default:N(()=>[O(U)]),_:1})),[[V,e.$t("chat_info")]])]),l("div",{ref_key:"scrollContainer",ref:f,class:"chat-view-body"},[M(Ke)&&a.value.length===0?(o(),g("div",hs,[O(R,{indeterminate:"",class:"sm"})])):(o(!0),g(Y,{key:1},ue(a.value,(w,Q)=>(o(),g("div",{key:w.id,class:"chat-item"},[Qe(w,Q)?(o(),g("div",gs,b(M(ge)(w.createdAt)),1)):E("",!0),O(ve,{modelValue:t[w.id],"onUpdate:modelValue":ke=>t[w.id]=ke,align:"top-left-to-bottom-left"},{trigger:N(()=>[l("div",ys,[l("span",ws,b(Be(w)),1),ae((o(),g("time",$s,[te(b(M(Rt)(w.createdAt)),1)])),[[V,M(Bt)(w.createdAt)]]),w.id.startsWith("new_")?(o(),g("span",bs,b(Re(w.id)),1)):E("",!0),O(J,{class:"bi bi-more"})])]),default:N(()=>[l("div",{class:de(["dropdown-item",{disabled:M(Ye)}]),onClick:ke=>{st(w.id),t[w.id]=!1}},b(e.$t("delete_message")),11,ks)]),_:2},1032,["modelValue","onUpdate:modelValue"]),l("div",Is,[w._content.type==="text"?(o(),g("div",Cs,[l("pre",{innerHTML:M(Ht)(w._content.value.text)},null,8,Ss),w._content.value.linkPreviews&&w._content.value.linkPreviews.length?(o(),q(De,{key:0,data:w},null,8,["data"])):E("",!0)])):(o(),q(Kt(He(w._content.type)),{key:1,data:w,"download-info":x[w.id]??null,peer:ee.value},null,8,["data","download-info","peer"]))])]))),128))],512),!ee.value||ee.value.status==="paired"?(o(),q(Xn,{key:1,modelValue:m.value,"onUpdate:modelValue":n[0]||(n[0]=w=>m.value=w),"create-loading":M(Je),onSendMessage:tt,onSendFiles:Ze,onSendImages:et},null,8,["modelValue","create-loading"])):E("",!0)],64)}}}),Es=Z(Ts,[["__scopeId","data-v-cf50bf2c"]]);export{Es as default};
