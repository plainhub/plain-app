var $e=Object.defineProperty;var Re=(_,e,o)=>e in _?$e(_,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):_[e]=o;var I=(_,e,o)=>Re(_,typeof e!="symbol"?e+"":e,o);import{m as ne,c,o as s,a,c5 as Le,c6 as Ee,d as Oe,u as Ae,s as qe,f as He,r as S,aD as ee,g as Qe,i as D,w as Ve,H as T,a7 as w,Z as Pe,$ as Ge,J as C,h as $,t as u,a0 as z,k as m,aW as Ue,aX as Fe,j as l,x as p,c0 as ze,M as k,O as R,P as We,al as xe,am as Be,c7 as Ne,C as je,au as Je,I as Xe,an as Ye,c8 as Ze,c9 as Ke,ca as en,cb as nn,cc as tn,cd as on,ce as an,cf as sn,bI as rn,R as W,cg as cn,L as ln}from"./index-yTvYptcc.js";import{t as H}from"./tapphone-oBfB-Syv.js";const dn={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function un(_,e){return s(),c("svg",dn,e[0]||(e[0]=[a("path",{fill:"currentColor",d:"m9.55 15.15l8.475-8.475q.3-.3.7-.3t.7.3t.3.713t-.3.712l-9.175 9.2q-.3.3-.7.3t-.7-.3L4.55 13q-.3-.3-.288-.712t.313-.713t.713-.3t.712.3z"},null,-1)]))}const pn=ne({name:"material-symbols-check-rounded",render:un}),_n={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function hn(_,e){return s(),c("svg",_n,e[0]||(e[0]=[a("path",{fill:"currentColor",d:"M6 16V8q0-.825.588-1.412T8 6h8q.825 0 1.413.588T18 8v8q0 .825-.587 1.413T16 18H8q-.825 0-1.412-.587T6 16"},null,-1)]))}const fn=ne({name:"material-symbols-stop-rounded",render:hn}),mn={xmlns:"http://www.w3.org/2000/svg",viewBox:"176.31 -11.19 346.88 581.88"};function vn(_,e){return s(),c("svg",mn,e[0]||(e[0]=[a("path",{d:"M470.49 0H229.51a41.9 41.9 0 0 0-29.547 12.277 41.9 41.9 0 0 0-12.277 29.547v476.35a41.9 41.9 0 0 0 12.277 29.547 41.9 41.9 0 0 0 29.547 12.277h240.98a41.9 41.9 0 0 0 29.547-12.277 41.9 41.9 0 0 0 12.277-29.547V41.824a41.9 41.9 0 0 0-12.277-29.547A41.9 41.9 0 0 0 470.49 0m33.25 518.18a33.33 33.33 0 0 1-9.766 23.484 33.34 33.34 0 0 1-23.484 9.766H229.51a33.33 33.33 0 0 1-23.484-9.766 33.34 33.34 0 0 1-9.765-23.484V41.83a33.33 33.33 0 0 1 9.828-23.371 33.32 33.32 0 0 1 23.422-9.703h240.98a33.33 33.33 0 0 1 23.484 9.765 33.34 33.34 0 0 1 9.765 23.484z"},null,-1),a("path",{d:"M317.62 46.812h64.75c2.418 0 4.375-1.957 4.375-4.375s-1.957-4.375-4.375-4.375h-64.75c-2.418 0-4.375 1.957-4.375 4.375s1.957 4.375 4.375 4.375M364.7 192.5a16.8 16.8 0 0 0-14.7-8.75 16.8 16.8 0 0 0-14.698 8.75l-91 157.5a16.45 16.45 0 0 0 0 16.977 16.6 16.6 0 0 0 6.101 6.386 16.65 16.65 0 0 0 8.512 2.364h182.09a16.626 16.626 0 0 0 14.7-8.75 16.8 16.8 0 0 0 0-16.977zm83.562 170.36a8.22 8.22 0 0 1-7.262 4.2H258.91a8.23 8.23 0 0 1-7.176-4.2 8.75 8.75 0 0 1 0-8.75l91-157.5a8.75 8.75 0 0 1 7.262-4.113 8.76 8.76 0 0 1 7.262 4.199l91 157.5a8.75 8.75 0 0 1 0 8.84z"},null,-1),a("path",{d:"M350 221.55a4.29 4.29 0 0 0-4.29 4.285v66.238a4.375 4.375 0 0 0 8.75 0v-66.238a4.286 4.286 0 0 0-4.46-4.285m0 91.26a4.29 4.29 0 0 0-4.29 4.29v17.061a4.375 4.375 0 0 0 8.75 0V317.1a4.286 4.286 0 0 0-4.46-4.29"},null,-1)]))}const gn={render:vn};class wn{constructor(e){I(this,"pc",null);I(this,"options");I(this,"audioEnabled",!1);I(this,"remoteDescriptionSet",!1);I(this,"pendingIceCandidates",[]);this.options=e}async startSession(e,o=!0){this.audioEnabled=e,this.cleanup(),this.remoteDescriptionSet=!1,this.pendingIceCandidates=[];const r={iceServers:[],iceCandidatePoolSize:0};if(this.pc=new RTCPeerConnection(r),this.pc.ontrack=t=>{if(t.streams&&t.streams.length>0)this.options.onStream(t.streams[0]);else{const h=new MediaStream;h.addTrack(t.track),this.options.onStream(h)}},this.pc.onicecandidate=t=>{t.candidate&&this.options.sendSignaling({type:"ice_candidate",candidate:t.candidate.candidate,sdpMid:t.candidate.sdpMid??void 0,sdpMLineIndex:t.candidate.sdpMLineIndex??void 0})},this.pc.onconnectionstatechange=()=>{this.pc&&this.options.onConnectionStateChange(this.pc.connectionState)},this.pc.oniceconnectionstatechange=()=>{var t;console.log("ICE connection state:",(t=this.pc)==null?void 0:t.iceConnectionState)},this.pc.addTransceiver("video",{direction:"recvonly"}),e&&this.pc.addTransceiver("audio",{direction:"recvonly"}),o)try{const t=await this.pc.createOffer();await this.pc.setLocalDescription(t),this.options.sendSignaling({type:"offer",sdp:t.sdp,sdpMid:e?"audio_enabled":"audio_disabled"})}catch(t){this.options.onError(`Failed to create offer: ${t}`)}else this.options.sendSignaling({type:"ready"})}async handleOffer(e){if(!this.pc){console.error("PeerConnection not initialized");return}try{const o=new RTCSessionDescription({type:"offer",sdp:e});await this.pc.setRemoteDescription(o),this.remoteDescriptionSet=!0,await this.flushPendingIceCandidates();const r=await this.pc.createAnswer();await this.pc.setLocalDescription(r),this.options.sendSignaling({type:"answer",sdp:r.sdp})}catch(o){this.options.onError(`Failed to handle offer: ${o}`)}}async handleAnswer(e){if(!this.pc){console.error("PeerConnection not initialized");return}try{const o=new RTCSessionDescription({type:"answer",sdp:e});await this.pc.setRemoteDescription(o),this.remoteDescriptionSet=!0,await this.flushPendingIceCandidates(),console.log("Remote description (answer) set successfully")}catch(o){this.options.onError(`Failed to set remote description: ${o}`)}}async handleIceCandidate(e,o,r){if(!this.pc){console.error("PeerConnection not initialized");return}if(!this.remoteDescriptionSet){this.pendingIceCandidates.push({candidate:e,sdpMid:o,sdpMLineIndex:r});return}try{await this.pc.addIceCandidate(new RTCIceCandidate({candidate:e,sdpMid:o??"",sdpMLineIndex:r??0}))}catch(t){console.error("Failed to add ICE candidate:",t)}}async flushPendingIceCandidates(){var o;const e=this.pendingIceCandidates;this.pendingIceCandidates=[];for(const r of e)try{await((o=this.pc)==null?void 0:o.addIceCandidate(new RTCIceCandidate({candidate:r.candidate,sdpMid:r.sdpMid??"",sdpMLineIndex:r.sdpMLineIndex??0})))}catch(t){console.error("Failed to add buffered ICE candidate:",t)}}sendControlEvent(e){this.options.sendSignaling({type:"control",sdp:JSON.stringify(e)})}setAudioEnabled(e){var o;if(this.audioEnabled=e,this.pc){const r=this.pc.getReceivers();for(const t of r)((o=t.track)==null?void 0:o.kind)==="audio"&&(t.track.enabled=e)}}isAudioEnabled(){return this.audioEnabled}async handleSignalingMessage(e){switch(e.type){case"offer":e.sdp&&await this.handleOffer(e.sdp);break;case"answer":e.sdp&&await this.handleAnswer(e.sdp);break;case"ice_candidate":e.candidate&&await this.handleIceCandidate(e.candidate,e.sdpMid,e.sdpMLineIndex);break;default:console.warn("Unknown signaling message type:",e.type)}}cleanup(){this.remoteDescriptionSet=!1,this.pendingIceCandidates=[],this.pc&&(this.pc.ontrack=null,this.pc.onicecandidate=null,this.pc.onconnectionstatechange=null,this.pc.oniceconnectionstatechange=null,this.pc.close(),this.pc=null)}getConnectionState(){var e;return((e=this.pc)==null?void 0:e.connectionState)??null}}function yn(_){Le.a.mutate({mutation:Ee,variables:{payload:_}}).catch(e=>{console.error("Failed to send WebRTC signaling via GraphQL:",e)})}const Cn={class:"screen-mirror"},Sn={class:"top-app-bar"},kn={class:"title"},bn={key:0,class:"warning-indicator"},Mn={class:"btn-icon warning-icon"},In={class:"warning-dropdown"},Dn={class:"warning-content"},Tn={class:"warning-text"},$n={key:1,class:"warning-indicator"},Rn={class:"btn-icon warning-icon"},Ln={class:"warning-dropdown"},En={class:"warning-content"},On={class:"warning-text"},An={class:"warning-actions"},qn={class:"actions"},Hn={key:1,class:"check-placeholder"},Qn={key:1,class:"check-placeholder"},Vn={key:1,class:"check-placeholder"},Pn={class:"content"},Gn={key:0},Un={key:0,class:"request-permission"},Fn={class:"tap-phone"},zn={class:"text"},Wn={key:1,class:"request-permission-failed"},xn=Oe({__name:"ScreenMirrorView",setup(_){let e;const{t:o}=Ae(),{app:r}=qe(He()),t=S(!1),h=S(0),v=S(!1),b=S(!1),L=S(),Q=S(!1),y=S("AUTO"),M=S(!1),te={AUTO:"mirror_auto",HD:"mirror_hd",SMOOTH:"mirror_smooth"},oe=ee(()=>o(te[y.value]||"mirror_auto"));let d=null,E=null;const x=async()=>{t.value=!0,v.value=!1,h.value=0,clearInterval(e),X()},B=ee(()=>ge.value||fe.value||V.value||b.value),N=()=>{we()};Ve(L,n=>{n&&E&&(n.srcObject=E,n.play().catch(()=>{}),E=null)});const{mutate:ae,loading:V}=D({document:Ze}),ie=()=>{M.value||(M.value=!0,H(o("confirm_mirror_audio_permission_on_phone")),se())},{mutate:se,onDone:re,onError:ce}=D({document:Ke});ce(n=>{M.value=!1,H(""),T(o(n.message),"error")}),re(n=>{var f;((f=n==null?void 0:n.data)==null?void 0:f.requestScreenMirrorAudio)&&(M.value=!1,H(""),w.emit("refetch_app"))});const j=()=>{M.value=!1,H(""),w.emit("refetch_app"),N()};let O=null;const{mutate:le,loading:de,onDone:ue}=D({document:en});ue(()=>{O!=null&&(y.value=O,O=null),Q.value=!1});const P=n=>{O=n,le({mode:n})},J=n=>{n&&V.value&&(clearInterval(e),G())},pe=()=>{const n=L.value;if(!n)return;const i=document.createElement("canvas");i.width=n.videoWidth,i.height=n.videoHeight;const f=i.getContext("2d");f&&f.drawImage(n,0,0,i.width,i.height);const g=new Date,A="screenshot-"+[g.getFullYear(),g.getMonth()+1,g.getDate(),g.getHours(),g.getMinutes(),g.getSeconds(),g.getMilliseconds()].join("")+".png";cn(i.toDataURL(),A)},_e=()=>{d&&d.cleanup(),d=new wn({sendSignaling:n=>{yn(n)},onStream:n=>{b.value=!1;const i=L.value;i?(i.srcObject=n,i.play().catch(()=>{}),t.value=!0,v.value=!1,h.value=0,clearInterval(e)):(E=n,t.value=!0,v.value=!1,h.value=0,clearInterval(e))},onConnectionStateChange:n=>{n==="connected"?b.value=!1:(n==="failed"||n==="disconnected")&&(b.value=!1,v.value=!0)},onError:n=>{b.value=!1,T(n,"error"),v.value=!0}})},X=()=>{b.value=!0,d==null||d.startSession(!0,!1)},Y=async n=>{d&&await d.handleSignalingMessage(n)};Pe(()=>{w.on("screen_mirroring",x),w.on("webrtc_signaling",Y),w.on("app_socket_connection_changed",J),w.on("screen_mirror_audio_granted",j),_e()}),Ge(()=>{w.off("screen_mirroring",x),w.off("webrtc_signaling",Y),w.off("app_socket_connection_changed",J),w.off("screen_mirror_audio_granted",j),d&&(d.cleanup(),d=null)});const{mutate:he,loading:fe,onDone:me,onError:ve}=D({document:nn}),{loading:ge,refetch:we}=Qe({handle:(n,i)=>{var f;i?T(o(i),"error"):((f=n==null?void 0:n.screenMirrorQuality)!=null&&f.mode&&(y.value=n.screenMirrorQuality.mode),n.screenMirrorState?X():(t.value=!1,G()))},options:{fetchPolicy:"no-cache"},document:tn}),G=()=>{v.value=!1,he({audio:!0})};ve(n=>{T(o(n.message)),v.value=!0}),me(()=>{h.value=30,e=setInterval(()=>{h.value--,h.value<=0&&(v.value=!0,clearInterval(e))},1e3)});const{mutate:ye,loading:Ce,onDone:Se,onError:ke}=D({document:on});return ke(n=>{T(o(n.message))}),Se(()=>{v.value=!0,t.value=!1,d&&d.cleanup()}),(n,i)=>{const f=an,g=sn,A=ze,Z=je,be=rn,K=Xe,Me=fn,U=Ye,F=pn,Ie=xe,De=Be,q=We("tooltip");return s(),c("div",Cn,[a("div",Sn,[a("div",kn,[C(u(n.$t("screen_mirror"))+" ",1),t.value?(s(),c(z,{key:0},[m(Ue)(m(Fe).MIRROR_AUDIO,m(r).osVersion)?m(r).permissions.includes("RECORD_AUDIO")?$("",!0):(s(),c("div",$n,[l(A,null,{content:p(()=>[a("div",Ln,[a("div",En,[l(g),a("div",On,u(n.$t("mirror_audio_no_permission")),1)]),a("div",An,[l(Z,{class:"btn-sm",loading:M.value,onClick:ie},{default:p(()=>[C(u(n.$t("grant_permission")),1)]),_:1},8,["loading"])])])]),default:p(()=>[a("button",Rn,[l(f)])]),_:1})])):(s(),c("div",bn,[l(A,null,{content:p(()=>[a("div",In,[a("div",Dn,[l(g),a("div",Tn,u(n.$t("mirror_audio_not_supported")),1)])])]),default:p(()=>[a("button",Mn,[l(f)])]),_:1})]))],64)):$("",!0)]),a("div",qn,[t.value?(s(),c(z,{key:0},[R((s(),k(K,{onClick:N},{default:p(()=>[l(be)]),_:1})),[[q,n.$t("refresh")]]),R((s(),k(K,{disabled:m(Ce),class:"btn-stop",onClick:m(ye)},{default:p(()=>[l(Me)]),_:1},8,["disabled","onClick"])),[[q,n.$t("stop_mirror")]]),l(Ie,{modelValue:Q.value,"onUpdate:modelValue":i[3]||(i[3]=Te=>Q.value=Te),placement:"auto",align:"top-left-to-bottom-left"},{trigger:p(()=>[R((s(),k(U,{class:"btn-sm",loading:m(de)},{default:p(()=>[C(u(oe.value),1)]),_:1},8,["loading"])),[[q,n.$t("mirror_quality")]])]),default:p(()=>[a("div",{class:W(["dropdown-item",{active:y.value==="AUTO"}]),onClick:i[0]||(i[0]=()=>P("AUTO"))},[y.value==="AUTO"?(s(),k(F,{key:0})):(s(),c("span",Hn)),C(" "+u(n.$t("mirror_auto")),1)],2),a("div",{class:W(["dropdown-item",{active:y.value==="HD"}]),onClick:i[1]||(i[1]=()=>P("HD"))},[y.value==="HD"?(s(),k(F,{key:0})):(s(),c("span",Qn)),C(" "+u(n.$t("mirror_hd")),1)],2),a("div",{class:W(["dropdown-item",{active:y.value==="SMOOTH"}]),onClick:i[2]||(i[2]=()=>P("SMOOTH"))},[y.value==="SMOOTH"?(s(),k(F,{key:0})):(s(),c("span",Vn)),C(" "+u(n.$t("mirror_smooth")),1)],2)]),_:1},8,["modelValue"]),R((s(),k(U,{class:"btn-sm",onClick:pe},{default:p(()=>[C(u(n.$t("screenshot")),1)]),_:1})),[[q,n.$t("screenshot")]])],64)):m(V)?$("",!0):(s(),k(U,{key:1,class:"btn-sm",onClick:m(ae)},{default:p(()=>[C(u(n.$t("relaunch_app")),1)]),_:1},8,["onClick"]))])]),a("div",Pn,[B.value?(s(),c("div",Gn,[l(De,{indeterminate:""})])):(s(),c(z,{key:1},[h.value>0?(s(),c("div",Un,[a("div",Fn,[l(m(Ne))]),a("pre",zn,u(n.$t("screen_mirror_request_permission",{seconds:h.value})),1)])):$("",!0),v.value&&!t.value?(s(),c("div",Wn,[l(m(gn)),a("p",null,u(n.$t("screen_mirror_request_permission_failed")),1),l(Z,{onClick:G},{default:p(()=>[C(u(n.$t("try_again")),1)]),_:1})])):$("",!0)],64)),R(a("video",{ref_key:"videoRef",ref:L,class:"video",controls:"true",autoplay:"",playsinline:"",muted:""},null,512),[[Je,t.value&&!B.value]])])])}}}),Jn=ln(xn,[["__scopeId","data-v-fa961dc3"]]);export{Jn as default};
